AWSTemplateFormatVersion: 2010-09-09
Description: Provides nesting for required stacks to deploy a full WordPress web application on Windows platform
  with reverse proxy, ALBs, IAM, and other resources (for demonstration/POC/testing)
Metadata:
  Stack:
    Value: 3
  VersionDate:
    Value: 20160510
  Identifier:
    Value: template-application
  Input:
    Description: VPC, SubnetIDs, S3 bucket names, CIDR blocks, KeyNames, AMIs
  Output:
    Description: Outputs ID of all deployed resources
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: Region Config
      Parameters:
      - pRegionAZ1Name
      - pRegionAZ2Name
    - Label:
        default: Network (existing VPC config)
      Parameters:
      - pProductionCIDR
      - pProductionVPC
      - pDMZSubnetA
      - pDMZSubnetB
      - pAppPrivateSubnetA
      - pAppPrivateSubnetB
      - pDBPrivateSubnetA
      - pDBPrivateSubnetB
    - Label:
        default: Application Configuration
      Parameters:
      - pWebInstanceType
      - pWebServerAMI
      - pAppInstanceType
      - pAppAmi
      - rCertificateArn
    - Label:
        default: Database Configuration
      Parameters:
      - pDBName
      - pDBUser
      - pDBPassword
      - pDBClass
      - pDBAllocatedStorage
    - Label:
        default: AWS Quick Start Configuration
      Parameters:
      - QSS3BucketName
      - QSS3BucketRegion
      - QSS3KeyPrefix
Parameters:
  pSecurityAlarmTopic:
    Description: SNS topic for alarms and notifications
    Type: String
    Default: ''
  pEC2KeyPair:
    Description: Key Name for Instance
    Type: String
    Default: ''
  pProductionCIDR:
    Description: Production VPC CIDR
    Type: String
  pManagementCIDR:
    Description: Management VPC CIDR
    Type: String
  pProductionVPC:
    Description: Production VPC
    Type: AWS::EC2::VPC::Id
  pBastionSSHCIDR:
    Description: CIDR block (optional) of Public IPs allowed to access Bastion instance
      in this deployment
    Type: String
    Default: 0.0.0.0/0
  pDMZSubnetA:
    Description: DMZ Subnet A
    Type: AWS::EC2::Subnet::Id
  pDMZSubnetB:
    Description: DMZ Subnet B
    Type: AWS::EC2::Subnet::Id
  pAppPrivateSubnetA:
    Description: WebApp Subnet A
    Type: AWS::EC2::Subnet::Id
  pAppPrivateSubnetB:
    Description: WebApp Subnet A
    Type: AWS::EC2::Subnet::Id
  pWebInstanceType:
    Description: Instance type for the webservers
    Type: String
  pAppInstanceType:
    Description: Instance type for the app webservers
    Type: String
  pDBPrivateSubnetA:
    Description: rDBPrivateSubnetA
    Type: AWS::EC2::Subnet::Id
  pDBPrivateSubnetB:
    Description: rDBPrivateSubnetB
    Type: AWS::EC2::Subnet::Id
  pRegionAZ1Name:
    Description: rDBPrivateSubnetB
    Type: AWS::EC2::AvailabilityZone::Name
  pRegionAZ2Name:
    Description: rDBPrivateSubnetB
    Type: AWS::EC2::AvailabilityZone::Name
  pWebServerAMI:
    Description: Which webserver AMI do you want to use, default
    Type: String
    Default: none
  pAppAmi:
    Description: Which App AMI do you want to use?
    Type: String
    Default: none
  DBEngine:
    Description: Specify the Database Engine.
    Type: String
    Default: MariaDB
    AllowedValues: [ MariaDB, MySQL, PostgreSQL, Oracle ]
  pDBName:
    Description: Name of RDS Database
    Type: String
  pDBUser:
    Description: Username of DB Instance
    Type: String
  pDBPassword:
    Description: Password of DB Instance
    NoEcho: true
    Type: String
  pDBClass:
    Description: Instance class of RDS instance
    Type: String
  pDBAllocatedStorage:
    Description: Allocated Storage (in GB) for RDS instance
    Type: String
  pEnvironment:
    Description: Environment type (development, test, or production)
    Type: String
    Default: development
  pSupportsGlacier:
    Description: Determines whether this region supports Glacier (passed in from main
      template)
    Type: String
    Default: 'true'
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-.]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, periods (.), and hyphens (-). It cannot start or
      end with a hyphen (-).
    Default: hipaa-on-aws-cirrusform
    Description: S3 bucket name for the Quick Start assets. Quick Start bucket name
      can include numbers, lowercase letters, uppercase letters, and hyphens (-).
      It cannot start or end with a hyphen (-).
    Type: String
  QSS3BucketRegion:
    Default: 'us-east-1'
    Description: The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value.
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/).
    Default: quickstart-compliance-hipaa/
    Description: S3 key prefix for the Quick Start assets. Quick Start key prefix
      can include numbers, lowercase letters, uppercase letters, hyphens (-), and
      forward slash (/).
    Type: String
  rCertificateArn:
    Description: SSL Certificate for application load balancer.
    Type: String
  Tag:
    Description: Specify Tag for the Stack.
    Default: 'Test'
    Type: String
    MaxLength: 20
  CertificateBucket:
    Description: Specify S3 Bucket name which contains the SSL certificate files.
    Default: hipaa-on-aws-cirrusform
    Type: String
    ConstraintDescription: Bucket name can include numbers, lowercase letters, uppercase letters, periods (.), and hyphens (-).
      It cannot start or end with a hyphen (-).
Mappings:
  elbMap:
    ap-northeast-1:
      ELB: '582318560864'
    ap-northeast-2:
      ELB: '600734575887'
    ap-south-1:
      ELB: '718504428378'
    ap-southeast-1:
      ELB: '114774131450'
    ap-southeast-2:
      ELB: '783225319266'
    ca-central-1:
      ELB: '985666609251'
    eu-central-1:
      ELB: '054676820928'
    eu-west-1:
      ELB: '156460612806'
    eu-west-2:
      ELB: '652711504416'
    sa-east-1:
      ELB: '507241528517'
    us-east-1:
      ELB: '127311923021'
    us-east-2:
      ELB: '033677994240'
    us-gov-west-1:
      ELB: '048591011584'
    us-west-1:
      ELB: '027434742980'
    us-west-2:
      ELB: '797873946194'
Conditions:
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'hipaa-on-aws-cirrusform']
  SupportsGlacier:
    !Equals
    - !Ref pSupportsGlacier
    - 'true'
  
  LaunchMariaDBInstance: !Equals [!Ref DBEngine, MariaDB ]
  # LaunchLinuxInstances: !Equals [ !Ref OsPlatform, Linux ]
  # LaunchUbuntuInstances: !Equals [ !Ref OsPlatform, Ubuntu ]
  # LaunchCentosInstances: !Equals [ !Ref OsPlatform, CentOs]
  # LaunchWindowsInstances: !Equals [ !Ref OsPlatform, Windows]
Resources:
  rS3ALBAccessLogs:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Join [ "-", [!Ref Tag, s3-alb-access-logs]]
      AccessControl: Private
  rS3AccessLogsPolicy:
    Type: AWS::S3::BucketPolicy
    DependsOn:
    - rS3ALBAccessLogs
    DeletionPolicy: Retain
    Properties:
      Bucket: !Ref rS3ALBAccessLogs
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ALBAccessLogs20130930
            Effect: Allow
            Resource: !Sub arn:aws:s3:::${rS3ALBAccessLogs}/AWSLogs/${AWS::AccountId}/*
            Principal: 
              AWS: 
                !FindInMap
                - elbMap
                - !Ref AWS::Region
                - ELB
            Action:
            - s3:PutObject

          - Sid: AWSLogDeliveryWrite
            Effect: Allow
            Principal:
              Service: 
                - delivery.logs.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub arn:aws:s3:::${rS3ALBAccessLogs}/AWSLogs/${AWS::AccountId}/*
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control
          - Sid: AWSLogDeliveryAclCheck
            Effect: Allow
            Principal:
              Service: 
                - delivery.logs.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !Sub arn:aws:s3:::${rS3ALBAccessLogs}
  rSecurityGroupWeb:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Join [ "-", [!Ref Tag, SecurityGroupWeb]]
      GroupDescription: Security group for Reverse Proxy in DMZ
      VpcId: !Ref pProductionVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0
      Tags:
      - Key: Name
        Value: sg-reverse-proxy-dmz
      - Key: Environment
        Value: !Ref pEnvironment
  rSecurityGroupWebInstance:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Join [ "-", [!Ref Tag, SecurityGroupWebInstance]]
      GroupDescription: Security group for Reverse Proxy Instances in DMZ
      VpcId: !Ref pProductionVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: !Ref pProductionCIDR
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: !Ref pProductionCIDR
      - IpProtocol: tcp
        FromPort: 3389
        ToPort: 3389
        CidrIp: !Ref pManagementCIDR
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0
      - IpProtocol: udp
        FromPort: 123
        ToPort: 123
        CidrIp: !Ref pProductionCIDR
      Tags:
      - Key: Name
        Value: sg-reverse-proxy-dmz-instances
      - Key: Environment
        Value: !Ref pEnvironment
  rSecurityGroupApp:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Join [ "-", [!Ref Tag, SecurityGroupApp]]
      GroupDescription: Security group for Appservers ALB
      VpcId: !Ref pProductionVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: !Ref pProductionCIDR
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0
      Tags:
      - Key: Name
        Value: sg-app-server-elb
      - Key: Environment
        Value: !Ref pEnvironment
  rSecurityGroupAppInstance:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Join [ "-", [!Ref Tag, SecurityGroupAppInstance]]
      GroupDescription: Security group for Appserver Instances
      VpcId: !Ref pProductionVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: !Ref pProductionCIDR
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: !Ref pProductionCIDR
      - IpProtocol: rdp
        FromPort: 3389
        ToPort: 3389
        CidrIp: !Ref pManagementCIDR
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0
      - IpProtocol: udp
        FromPort: 123
        ToPort: 123
        CidrIp: !Ref pProductionCIDR
      - IpProtocol: tcp
        FromPort: 3306
        ToPort: 3306
        CidrIp: !Ref pProductionCIDR
      Tags:
      - Key: Name
        Value: sg-app-server-elb-instances
      - Key: Environment
        Value: !Ref pEnvironment
  rSecurityGroupRDS:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Join [ "-", [!Ref Tag, SecurityGroupRDS]]
      GroupDescription: Port 3306 database for access
      VpcId: !Ref pProductionVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 3306
        ToPort: 3306
        SourceSecurityGroupId: !Ref rSecurityGroupAppInstance
      Tags:
      - Key: Name
        Value: sg-database-access
      - Key: Environment
        Value: !Ref pEnvironment
  rWebContentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Join [ "-", [!Ref Tag, web-content-bucket ]]
      AccessControl: Private
      LifecycleConfiguration:
        Rules:
        - Id: Transition90daysRetain7yrs
          Status: Enabled
          ExpirationInDays: 2555
          Transition:
            TransitionInDays: 90
            StorageClass:
              !If
              - SupportsGlacier
              - GLACIER
              - STANDARD_IA
      VersioningConfiguration:
        Status: Enabled
    DeletionPolicy: Delete
  rWebContentS3Policy:
    Type: AWS::S3::BucketPolicy
    DependsOn: rWebContentBucket
    Properties:
      Bucket: !Ref rWebContentBucket
      PolicyDocument:
        Statement:
        - Sid: EnforceSecureTransport
          Action: s3:*
          Effect: Deny
          Principal: '*'
          Resource: !Sub arn:${AWS::Partition}:s3:::${rWebContentBucket}
          Condition:
            Bool:
              aws:SecureTransport: 'false'
        - Sid: EnforceEncryptionOnPut
          Effect: Deny
          Principal: '*'
          Action: s3:PutObject
          Resource: !Sub arn:${AWS::Partition}:s3:::${rWebContentBucket}/*
          Condition:
            StringNotEquals:
              s3:x-amz-server-side-encryption: AES256
  rDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Join [ "-", [!Ref Tag, DBSubnetGroup ]]
      DBSubnetGroupDescription: MySQL RDS Subnet Group
      SubnetIds:
      - !Ref pDBPrivateSubnetA
      - !Ref pDBPrivateSubnetB
  rRDSInstanceMySQL:
    Type: AWS::RDS::DBInstance
    Condition: LaunchMariaDBInstance
    DependsOn:
    - rDBSubnetGroup
    - rSecurityGroupRDS
    Properties:
      DBInstanceIdentifier: !Join ["-", [!Ref Tag, DbInstance]]
      DBName: !Ref pDBName
      Engine: !Ref DBEngine
      MultiAZ: true
      StorageEncrypted: true
      MasterUsername: !Ref pDBUser
      MasterUserPassword: !Ref pDBPassword
      DBInstanceClass: !Ref pDBClass
      AllocatedStorage: !Ref pDBAllocatedStorage
      VPCSecurityGroups:
      - !Ref rSecurityGroupRDS
      DBSubnetGroupName: !Ref rDBSubnetGroup

### Application Load Balancers
  rALBApp:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    DependsOn:
    - rS3ALBAccessLogs
    - rS3AccessLogsPolicy
    - rSecurityGroupApp
    Properties: 
      # IpAddressType: ipv4
      LoadBalancerAttributes: 
      - Key: access_logs.s3.enabled
        Value: true
      - Key: access_logs.s3.bucket
        Value: !Ref rS3ALBAccessLogs
      # - Key: access_logs.s3.prefix
      #   Value: Alb-App-Logs
      Name: !Join [ "-", [!Ref Tag, ALBApp]]
      Scheme: internal
      SecurityGroups: 
      - !Ref rSecurityGroupWeb
      Subnets: 
      - !Ref pAppPrivateSubnetA
      - !Ref pAppPrivateSubnetB
      Tags: 
      - Key: Name
        Value: !Join [ "-", [!Ref Tag, App ALB]]
      - Key: Environment
        Value: !Ref pEnvironment
      Type: application
##### Create a Listener 
  HTTPlistenerApp:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    DependsOn:
    - rALBApp
    - rTargetGroupApp
    Properties:
      Certificates: 
      - CertificateArn: !Ref rCertificateArn
      DefaultActions:
        - Type: "forward"
          ForwardConfig:
            TargetGroups: 
            - TargetGroupArn: !Ref rTargetGroupApp
              Weight: 1
      LoadBalancerArn: !Ref rALBApp
      Port: "443"
      Protocol: "HTTPS"
## Target Group
  rTargetGroupApp:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties: 
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: /
      HealthCheckPort: traffic-port
      HealthCheckProtocol: HTTPS
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 5
      Matcher: 
         HttpCode: 200
      Name: !Join [ "-", [!Ref Tag, TargetGroupApp]]
      Port: 443
      Protocol: HTTPS
      Tags: 
      - Key: Name
        Value: !Join [ "-", [!Ref Tag, TargetGroupApp]]
      - Key: Environment
        Value: !Ref pEnvironment
      # TargetGroupAttributes: 
      #   - TargetGroupAttribute
      # Targets: 
      #   - TargetDescription
      # TargetType: instance
      UnhealthyThresholdCount: 2
      VpcId: !Ref pProductionVPC

  rALBWeb:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    DependsOn:
    - rS3ALBAccessLogs
    - rSecurityGroupWeb
    - rS3AccessLogsPolicy
    Properties: 
      # IpAddressType: ipv4
      LoadBalancerAttributes: 
      - Key: access_logs.s3.enabled
        Value: true
      - Key: access_logs.s3.bucket
        Value: !Ref rS3ALBAccessLogs
      # - Key: access_logs.s3.prefix
      #   Value: Alb-Web-Logs
      Name: !Join [ "-", [!Ref Tag, ALBWeb]]
      Scheme: internet-facing
      SecurityGroups: 
      - !Ref rSecurityGroupWeb
      # SubnetMappings:
      # - SubnetId: 
      Subnets: 
      - !Ref pDMZSubnetA
      - !Ref pDMZSubnetB
      Tags: 
      - Key: Name
        Value: !Join [ "-", [!Ref Tag, Proxy ALB]]
      - Key: Environment
        Value: !Ref pEnvironment
      Type: application
##### Create a Listener 
  HTTPlistenerWeb:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    DependsOn:
    - rALBWeb
    - rTargetGroupWeb
    Properties:
      Certificates: 
      - CertificateArn: !Ref rCertificateArn
      DefaultActions:
        - Type: "forward"
          ForwardConfig:
            TargetGroups: 
            - TargetGroupArn: !Ref rTargetGroupWeb
              Weight: 1
      LoadBalancerArn: !Ref rALBWeb
      Port: "443"
      Protocol: "HTTPS"
  rTargetGroupWeb:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties: 
      HealthCheckEnabled: true
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: /
      HealthCheckPort: traffic-port
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 5
      Matcher: 
         HttpCode: 301
      Name: !Join [ "-", [!Ref Tag, TargetGroupWeb]]
      Port: 80
      Protocol: HTTP
      Tags: 
      - Key: Name
        Value: Web ALB
      - Key: Environment
        Value: !Ref pEnvironment
      # TargetGroupAttributes: 
      #   - TargetGroupAttribute
      # Targets: 
      #   - TargetDescription
      # TargetType: instance
      UnhealthyThresholdCount: 2
      VpcId: !Ref pProductionVPC

  rS3AssetsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketName: !Join [ "-", [!Ref Tag, s3-assets-bucket]]
      AccessControl: Private
  rPreProcInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join ["-", [!Ref Tag, PreProcInstanceRole]]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: PreProcPermissions
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Sid: UploadServerCertificate
            Effect: Allow
            Action:
            - s3:PutObject
            Resource: !Sub arn:${AWS::Partition}:s3:::${rS3AssetsBucket}/*
          - Sid: SelfDestruct
            Effect: Allow
            Action:
            - ec2:TerminateInstances
            Resource:
            - '*'
  rPreProcInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
      - !Ref rPreProcInstanceRole
      InstanceProfileName: !Join ["-", [ !Ref Tag, PreProcInstanceProfile]]
  rPreProcInstance:
    Type: AWS::EC2::Instance
    # Condition: LaunchLinuxInstances: !Equals [ !Ref OsPlatform, Linux ]
    Properties:
      KeyName: !Ref pEC2KeyPair
      ImageId: !Ref pWebServerAMI
      InstanceType: !Ref pAppInstanceType
      IamInstanceProfile: !Ref rPreProcInstanceProfile
      SubnetId: !Ref pAppPrivateSubnetA
      SecurityGroupIds:
      - !Ref rSecurityGroupAppInstance
      # UserData:
      #   Fn::Base64: !Sub |
      #     #!/bin/bash -xe

      #     echo Force S3 to use Sigv4
      #     aws configure set default.s3.signature_version s3v4

      #     echo Configure the region, necessary especially for GovCloud
      #     aws configure set region ${AWS::Region}

      #     echo Generating private certificate...
      #     # sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /tmp/common.key -out /tmp/common.crt -subj "/C=US/ST=Washington/L=Seattle/O=NonProductionTestCert/CN=NonProductionTestCert"

      #     # echo Uploading key to assets bucket...
      #     # aws s3api put-object --bucket ${rS3AssetsBucket} --key ssl/common.key --body /tmp/common.key

      #     # echo Uploading cert to assets bucket...
      #     # aws s3api put-object --bucket ${rS3AssetsBucket} --key ssl/common.crt --body /tmp/common.crt

      #     echo Signal for success
      #     /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource rPreProcInstance --region ${AWS::Region}

      #     echo Sleeping for 2 minutes to allow CloudFormation to catch up
      #     sleep 120

      #     echo Self-destruct!
      #     aws ec2 terminate-instances --instance-id $(curl -s http://169.254.169.254/latest/meta-data/instance-id) --region ${AWS::Region}
      Tags:
      - Key: Name
        Value: !Join [ "-", [!Ref Tag, PreProcessor]]
    # CreationPolicy:
    #   ResourceSignal:
    #     Timeout: PT10M
  rWebInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join ["-", [!Ref Tag, WebInstanceRole]]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: S3Assets
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Sid: GetServerCertificate
            Effect: Allow
            Action:
            - s3:Get*
            - s3:List*
            - s3:Head*
            Resource:
            # - !Sub arn:${AWS::Partition}:s3:::${rS3AssetsBucket}/*
            # - !Sub arn:${AWS::Partition}:s3:::${rS3AssetsBucket}
            - !Sub arn:${AWS::Partition}:s3:::${CertificateBucket}/*
            - !Sub arn:${AWS::Partition}:s3:::${CertificateBucket}
          - Sid: DescribeVolumes
            Effect: Allow
            Action:
            - ec2:DescribeVolumes
            Resource: '*'
      - PolicyName: aws-quick-start-s3-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Action:
              - s3:GetObject
            Resource: !Sub
              - arn:${AWS::Partition}:s3:::${S3Bucket}/${QSS3KeyPrefix}*
              - S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}', !Ref QSS3BucketName]
            Effect: Allow
  rWebInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
      - !Ref rWebInstanceRole
      InstanceProfileName: !Join ["-", [ !Ref Tag, WebInstanceProfile]]
  rAutoScalingConfigWeb:
    Type: AWS::AutoScaling::LaunchConfiguration
    DependsOn:
    - rALBApp
    - rAutoScalingGroupApp
    # - rPreProcInstance
    Metadata:
      AWS::CloudFormation::Init:
        config:
          files:
            c:\cfn\cfn-hup.conf:
              content:
                Fn::Join:
                - ''
                - - "[main]\n"
                  - stack=
                  - Ref: AWS::StackId
                  - "\n"
                  - region=
                  - Ref: AWS::Region
                  - "\n"
            c:\cfn\hooks.d\cfn-auto-reloader.conf:
              content:
                Fn::Join:
                - ''
                - - "[cfn-auto-reloader-hook]\n"
                  - 'triggers=post.update

                    '
                  - 'path=Resources.rAutoScalingConfigWeb.Metadata.AWS::CloudFormation::Init

                    '
                  - 'action=cfn-init.exe -v -s '
                  - Ref: AWS::StackId
                  - " -r rAutoScalingConfigWeb"
                  - " --region "
                  - Ref: AWS::Region
                  - "\n"
          services:
            windows:
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                - c:\cfn\cfn-hup.conf
                - c:\cfn\hooks.d\cfn-auto-reloader.conf
    Properties:
      AssociatePublicIpAddress: true
      ImageId: !Ref pWebServerAMI
      IamInstanceProfile: !Ref rWebInstanceProfile
      InstanceType: !Ref pWebInstanceType
      BlockDeviceMappings:
      - DeviceName: /dev/sdh
        Ebs:
          VolumeSize: 50
          VolumeType: gp2
          Encrypted: true
      KeyName: !Ref pEC2KeyPair
      LaunchConfigurationName: !Join [ "-", [!Ref Tag, AutoScalingConfigWeb ]]
      SecurityGroups:
      - !Ref rSecurityGroupWebInstance
      # UserData:
      #   Fn::Base64: !Sub |
      #     #!/bin/bash
      #     yum update -y
          
      #     # install SSL cert common key
      #     yum -y install mod_ssl

      #     aws configure set default.s3.signature_version s3v4
      #     # aws s3 cp s3://${rS3AssetsBucket}/ssl/common.crt /etc/ssl/certs/common.crt --region ${AWS::Region}
      #     # aws s3 cp s3://${rS3AssetsBucket}/ssl/common.key /etc/ssl/private/common.key --region ${AWS::Region}
      #     aws s3 cp s3://${CertificateBucket}/ssl/common.cert /etc/ssl/certs/common.crt --region ${AWS::Region}
      #     aws s3 cp s3://${CertificateBucket}/ssl/common.key /etc/ssl/private/common.key --region ${AWS::Region}      
          
      #     EC2_INSTANCE_ID=$(curl -s http://instance-data/latest/meta-data/instance-id)

      #     ######################################################################
      #     # Volume /dev/sdh (which will get created as /dev/xvdh on Amazon Linux)

      #     DATA_STATE="unknown"
      #     until [ "${!DATA_STATE}" == "attached" ]; do
      #       DATA_STATE=$(aws ec2 describe-volumes \
      #       --region ${AWS::Region} \
      #       --filters \
      #             Name=attachment.instance-id,Values=${!EC2_INSTANCE_ID} \
      #             Name=attachment.device,Values=/dev/sdh \
      #       --query Volumes[].Attachments[].State \
      #       --output text)

      #       sleep 5
      #     done

      #     # Format /dev/xvdh if it does not contain a partition yet
      #     if [ "$(file -b -s /dev/xvdh)" == "data" ]; then
      #       mkfs -t ext4 /dev/xvdh
      #     fi

      #     mkdir -p /data
      #     mount /dev/xvdh /data

      #     # Persist the volume in /etc/fstab so it gets mounted again
      #     echo '/dev/xvdh /data ext4 defaults,nofail 0 2' >> /etc/fstab

      #     /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource rAutoScalingConfigWeb --region ${AWS::Region}

      #     ## Nginx setup
      #     sleep 5
      #     cp /tmp/nginx/default.conf /etc/nginx/conf.d/default.conf
      #     service nginx stop
      #     sed -i '/default_server;/d' /etc/nginx/nginx.conf
      #     sleep 10
      #     service nginx restart
  rAutoScalingGroupWeb:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn: 
    - rAutoScalingConfigWeb
    - rTargetGroupWeb
    Properties:
      AutoScalingGroupName: !Join [ "-", [!Ref Tag, AutoScalingGroupWeb]]
      AvailabilityZones:
      - !Ref pRegionAZ1Name
      - !Ref pRegionAZ2Name
      VPCZoneIdentifier:
      - !Ref pDMZSubnetA
      - !Ref pDMZSubnetB
      LaunchConfigurationName: !Ref rAutoScalingConfigWeb
      MinSize: "2"
      MaxSize: "4"
      # LoadBalancerNames:
      # - !Ref rALBWeb
      # HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      TargetGroupARNs:
        - !Ref rTargetGroupWeb
      Tags:
      - Key: Name
        Value: !Join [ "-", [!Ref Tag, Proxy Server]]
        PropagateAtLaunch: true
      - Key: Environment
        Value: !Ref pEnvironment
        PropagateAtLaunch: true
  rAutoScalingUpWeb:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref rAutoScalingGroupWeb
      Cooldown: "500"
      ScalingAdjustment: 1
  rAutoScalingDownWeb:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref rAutoScalingGroupWeb
      Cooldown: "500"
      ScalingAdjustment: -1
  rCWAlarmHighCPUWeb:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Join ["-", [!Ref Tag, CWAlarmHighCPUWeb]]
      EvaluationPeriods: 1
      Statistic: Average
      Threshold: 50
      AlarmDescription: Alarm if CPU too high or metric disappears indicating instance
        is down
      Period: 60
      AlarmActions:
      - !Ref rAutoScalingUpWeb
      Namespace: AWS/EC2
      Dimensions:
      - Name: AutoScalingGroupName
        Value: !Ref rAutoScalingGroupWeb
      ComparisonOperator: GreaterThanThreshold
      MetricName: CPUUtilization
  rCWAlarmLowCPUWeb:
    Type: AWS::CloudWatch::Alarm
    DependsOn: rAutoScalingGroupWeb
    Properties:
      AlarmName: !Join ["-", [!Ref Tag, CWAlarmLowCPUWeb]]
      EvaluationPeriods: 1
      Statistic: Average
      Threshold: 10
      AlarmDescription: Alarm if CPU too low, remove a web server
      Period: 60
      AlarmActions:
      - !Ref rAutoScalingDownWeb
      Namespace: AWS/EC2
      Dimensions:
      - Name: AutoScalingGroupName
        Value: !Ref rAutoScalingGroupWeb
      ComparisonOperator: LessThanThreshold
      MetricName: CPUUtilization
  rAppInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join ["-", [!Ref Tag, AppInstanceRole]]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: S3Assets
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Sid: GetServerCertificate
            Effect: Allow
            Action:
            - s3:Get*
            - s3:List*
            - s3:Head*
            Resource:
            # - !Sub arn:${AWS::Partition}:s3:::${rS3AssetsBucket}/*
            # - !Sub arn:${AWS::Partition}:s3:::${rS3AssetsBucket}
            - !Sub arn:${AWS::Partition}:s3:::${CertificateBucket}/*
            - !Sub arn:${AWS::Partition}:s3:::${CertificateBucket}
            - !Sub
              - arn:${AWS::Partition}:s3:::${S3Bucket}
              - S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}', !Ref QSS3BucketName]
            - !Sub
              - arn:${AWS::Partition}:s3:::${S3Bucket}/${QSS3KeyPrefix}*
              - S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}', !Ref QSS3BucketName]
          - Sid: DescribeVolumes
            Effect: Allow
            Action:
            - ec2:DescribeVolumes
            Resource: '*'
      - PolicyName: aws-quick-start-s3-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Action:
              - s3:GetObject
            Resource:
              - !Sub
                - arn:${AWS::Partition}:s3:::${S3Bucket}
                - S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}', !Ref QSS3BucketName]
              - !Sub
                - arn:${AWS::Partition}:s3:::${S3Bucket}/${QSS3KeyPrefix}*
                - S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}', !Ref QSS3BucketName]
            Effect: Allow
  rAppInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - Ref: 'rAppInstanceRole'
      InstanceProfileName: !Join ["-", [ !Ref Tag, AppInstanceProfile]]
  rAutoScalingConfigApp:
    Type: AWS::AutoScaling::LaunchConfiguration
    DependsOn:
    - rRDSInstanceMySQL
    # - rPreProcInstance
    Metadata:
      AWS::CloudFormation::Init:
        config:
          files:
            c:\cfn\cfn-hup.conf:
              content:
                Fn::Join:
                - ''
                - - "[main]\n"
                  - stack=
                  - Ref: AWS::StackId
                  - "\n"
                  - region=
                  - Ref: AWS::Region
                  - "\n"
            c:\cfn\hooks.d\cfn-auto-reloader.conf:
              content:
                Fn::Join:
                - ''
                - - "[cfn-auto-reloader-hook]\n"
                  - 'triggers=post.update

                    '
                  - 'path=Resources.rAutoScalingGroupApp.Metadata.AWS::CloudFormation::Init

                    '
                  - 'action=cfn-init.exe -v -s '
                  - Ref: AWS::StackId
                  - " -r rAutoScalingGroupApp"
                  - " --region "
                  - Ref: AWS::Region
                  - "\n"
          #   C:\SharePoint\SharePointFoundation2010.exe:
          #     source: http://d3adzpja92utk0.cloudfront.net/SharePointFoundation.exe
          # commands:
          #   1-extract:
          #     command: C:\SharePoint\SharePointFoundation2010.exe /extract:C:\SharePoint\SPF2010
          #       /quiet /log:C:\SharePoint\SharePointFoundation2010-extract.log
          #   2-prereq:
          #     command: C:\SharePoint\SPF2010\PrerequisiteInstaller.exe /unattended
          #   3-install:
          #     command: C:\SharePoint\SPF2010\setup.exe /config C:\SharePoint\SPF2010\Files\SetupSilent\config.xml
          services:
            windows:
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                - c:\cfn\cfn-hup.conf
                - c:\cfn\hooks.d\cfn-auto-reloader.conf
    Properties:
      ImageId: !Ref pAppAmi
      IamInstanceProfile: !Ref rAppInstanceProfile
      InstanceType: !Ref pAppInstanceType
      BlockDeviceMappings:
      - DeviceName: /dev/sdh
        Ebs:
          VolumeSize: 50
          VolumeType: gp2
          Encrypted: true
      KeyName: !Ref pEC2KeyPair
      LaunchConfigurationName: !Join [ "-", [!Ref Tag, AutoScalingConfigApp ]]
      SecurityGroups:
      - !Ref rSecurityGroupAppInstance
      # UserData:
      #   Fn::Base64:
      #     Fn::Join:
      #     - ''
      #     - - "<script>\n"
      #       - 'cfn-init.exe -v -s '
      #       - Ref: AWS::StackId
      #       - " -r rAutoScalingConfigApp"
      #       - " --region "
      #       - Ref: AWS::Region
      #       - "\n"
      #       - 'cfn-signal.exe -e %ERRORLEVEL% --stack ${AWS::StackName} --resource rAutoScalingGroupApp --region ${AWS::Region} '
      #       # - Fn::Base64:
      #       #     Ref: SharePointFoundationWaitHandle
      #       - "\n"
      #       - "</script>"
        
  rAutoScalingGroupApp:
    Type: AWS::AutoScaling::AutoScalingGroup
    DependsOn: 
    - rAutoScalingConfigApp
    - rTargetGroupApp
    Properties:
      AutoScalingGroupName: !Join [ "-", [!Ref Tag, AutoScalingGroupApp]]
      AvailabilityZones:
      - !Ref pRegionAZ1Name
      - !Ref pRegionAZ2Name
      VPCZoneIdentifier:
      - !Ref pAppPrivateSubnetA
      - !Ref pAppPrivateSubnetB
      LaunchConfigurationName: !Ref rAutoScalingConfigApp
      MinSize: "2"
      MaxSize: "4"
      # LoadBalancerNames:
      # - !Ref rALBApp
      # HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      TargetGroupARNs:
        - !Ref rTargetGroupApp
      Tags:
      - Key: Name
        Value: !Join [ "-", [!Ref Tag, AppServer ]]
        PropagateAtLaunch: true
      - Key: Environment
        Value: !Ref pEnvironment
        PropagateAtLaunch: true
    # CreationPolicy:
    #   ResourceSignal:
    #     Count: 1
    #     Timeout: PT15M
  rAutoScalingDownApp:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref rAutoScalingGroupApp
      Cooldown: "1"
      ScalingAdjustment: 1
  rAutoScalingUpApp:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref rAutoScalingGroupApp
      Cooldown: "1"
      ScalingAdjustment: -1
  rCWAlarmHighCPUApp:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Join ["-", [!Ref Tag, CWAlarmHighCPUApp]]
      EvaluationPeriods: 1
      Statistic: Average
      Threshold: 50
      AlarmDescription: Alarm if CPU too high or metric disappears indicating instance
        is down
      Period: 60
      AlarmActions:
      - !Ref rAutoScalingDownApp
      Namespace: AWS/EC2
      Dimensions:
      - Name: AutoScalingGroupName
        Value: !Ref rAutoScalingGroupApp
      ComparisonOperator: GreaterThanThreshold
      MetricName: CPUUtilization
  rCWAlarmLowCPUApp:
    Type: AWS::CloudWatch::Alarm
    Properties: 
      AlarmName: !Join ["-", [!Ref Tag, CWAlarmLowCPUApp]]
      EvaluationPeriods: 1
      Statistic: Average
      Threshold: 10
      AlarmDescription: Alarm if CPU too low, remove an app server
      Period: 60
      AlarmActions:
      - !Ref rAutoScalingUpApp
      Namespace: AWS/EC2
      Dimensions:
      - Name: AutoScalingGroupName
        Value: !Ref rAutoScalingGroupApp
      ComparisonOperator: LessThanThreshold
      MetricName: CPUUtilization
  rPostProcInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join ["-", [!Ref Tag, PostProcInstanceRole]]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: /
      Policies:
      - PolicyName: PostProcPermissions
        PolicyDocument:
          Version: 2012-10-17
          Statement:
          - Sid: UploadServerCertificate
            Effect: Allow
            Action:
            - iam:ListServerCertificates
            - iam:UploadServerCertificate
            Resource:
            - '*'
          - Sid: CreateLoadBalancerListener
            Effect: Allow
            Action:
            - elasticloadbalancing:CreateLoadBalancerListeners
            Resource:
            - '*'
          - Sid: PublishNotificationTopic
            Effect: Allow
            Action:
            - sns:Publish
            Resource:
            - !Ref pSecurityAlarmTopic
          - Sid: SelfDestruct
            Effect: Allow
            Action:
            - ec2:TerminateInstances
            Resource:
            - '*'
  rPostProcInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
      - !Ref rPostProcInstanceRole
      InstanceProfileName: !Join ["-", [ !Ref Tag, PostProcInstanceProfile]]
  rPostProcInstance:
    Type: AWS::EC2::Instance
    DependsOn:
    - rAutoScalingGroupApp
    - rAutoScalingGroupWeb
    Properties:
      ImageId: !Ref pWebServerAMI
      InstanceType: !Ref pAppInstanceType
      IamInstanceProfile: !Ref rPostProcInstanceProfile
      SubnetId: !Ref pAppPrivateSubnetA
      SecurityGroupIds:
      - !Ref rSecurityGroupAppInstance
      # UserData:
      #   Fn::Base64: !Sub |
      #     #!/bin/bash -xe

      #     echo Configure the region, necessary especially for GovCloud
      #     aws configure set region ${AWS::Region}

      #     echo Send notification message...
      #     aws sns publish --topic-arn ${pSecurityAlarmTopic} \
      #       --subject "CloudFormation successfully launched ${AWS::StackName}" \
      #       --message "What now? Click here for more information: https://${rALBWeb.DNSName}/landing.html. Please note that the application server might be finishing up its initialization. If the link doesn't respond right away, please try it again in few minutes. This page resides on an application server in your new environment." \
      #       --region ${AWS::Region}

      #     echo Sleeping for 2 minutes to allow CloudFormation to catch up
      #     sleep 120

      #     echo Self-destruct!
      #     aws ec2 terminate-instances --instance-id $(curl -s http://169.254.169.254/latest/meta-data/instance-id) --region ${AWS::Region}
      Tags:
      - Key: Name
        Value: !Join [ "-", [!Ref Tag, PostProcessor]]
Outputs:
  SourceSecurityGroupForRDS:
    Value: !Ref rSecurityGroupAppInstance
    Description: Source security group for RDS security group.
    Export:
      Name: !Sub '${Tag}-rSecurityGroupAppInstance'
  # LandingPageURL:
  #   Value: !Sub https://${rALBWeb.DNSName}/landing.html
  #   Description: Landing Page
  # WebsiteURL:
  #   Value: !Sub https://${rALBWeb.DNSName}/wordpress/wp-admin/install.php
  #   Description: WordPress Website (demonstration purposes only)
  rSecurityGroupWeb:
    Value: !Ref rSecurityGroupWeb
  rSecurityGroupApp:
    Value: !Ref rSecurityGroupApp
  rSecurityGroupRDS:
    Value: !Ref rSecurityGroupRDS
  SurveyLink:
    Value: https://aws.au1.qualtrics.com/SE/?SID=SV_55sYYdtY1NhTTgN&qs=hipaa
    Description: Please take a moment to complete the survey by clicking this link
  Help:
    Description: For assistance or questions regarding this quickstart please email
      compliance-accelerator@amazon.com
    Value: ''